<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transmittal Dashboard</title>
    <!-- Include Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for list */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9; /* gray-100 */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8; /* gray-400 */
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* gray-500 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen overflow-hidden">
        
        <!-- Left Panel: Transmittal List -->
        <aside class="w-1/3 max-w-sm border-r border-gray-200 bg-white">
            <header class="border-b border-gray-200 p-4">
                <h1 class="text-xl font-bold text-gray-900">Transmittal</h1>
            </header>
            <nav id="transmittal-list" class="flex-1 overflow-y-auto custom-scrollbar p-2" style="height: calc(100vh - 65px);">
                <!-- Transmittal items will be dynamically inserted by JS -->
                <div class="p-4 text-center text-gray-500">Loading...</div>
            </nav>
        </aside>

        <!-- Right Panel: Detail View -->
        <main id="detail-view" class="flex-1 overflow-y-auto custom-scrollbar" style="height: 100vh;">
            <div class="flex h-full items-center justify-center">
                <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M5 11v2m14-2v2" />
                    </svg>
                    <h2 class="mt-2 text-lg font-medium text-gray-900">Select a Transmittal</h2>
                    <p class="mt-1 text-sm text-gray-500">Please select a transmittal from the list on the left to see its details.</p>
                </div>
            </div>
            <!-- Detail content will be dynamically inserted by JS -->
        </main>
    </div>

    <script>
        // --- Mock Data ---
        // This is your CSV data, converted to JSON format
        // 1. transmittals_workflow_transmittals.csv
        const rawTransmittals = [
          {"id":"38afb8fd-c4d1-4d49-8750-84c1945479ba", "title":"test 1", "create_user_name":"Khalil Chiu", "docs_count":3, "created_at":"2025-10-27 06:24:00.538", "status": 2},
          {"id":"856313e9-272c-4048-8987-e13a58ab3b9c", "title":"06 isBIM[TEST 2]", "create_user_name":"Khalil Chiu", "docs_count":2, "created_at":"2025-10-27 06:25:45.581", "status": 2}
        ];

        // 2. transmittals_transmittal_documents.csv
        // *** Updated: Added URN and parent_folder_urn fields ***
        const rawDocuments = [
          {"workflow_transmittal_id":"38afb8fd-c4d1-4d49-8750-84c1945479ba", "urn": "5PfUdMeESQ6S8XmZ5lCPaw", "file_name":"麦当劳结构模型.rvt", "version_number":1, "parent_folder_urn": "urn:adsk.wipprod:fs.folder:co.3JagzATeQSmJI_o8djvF_Q"},
          {"workflow_transmittal_id":"38afb8fd-c4d1-4d49-8750-84c1945479ba", "urn": "N0ZqISU3Qw-ZmDsZikbp4w", "file_name":"BIM Integration Prototype 1.0.pdf", "version_number":1, "parent_folder_urn": "urn:adsk.wipprod:fs.folder:co.3JagzATeQSmJI_o8djvF_Q"},
          {"workflow_transmittal_id":"38afb8fd-c4d1-4d49-8750-84c1945479ba", "urn": "m8aOlqG2TG6SNIvt58U-Zg", "file_name":"Acc Back up 需求文档.docx", "version_number":1, "parent_folder_urn": "urn:adsk.wipprod:fs.folder:co.7ajfDFd6TuWQCKLqpyf9NA"},
          {"workflow_transmittal_id":"856313e9-272c-4048-8987-e13a58ab3b9c", "urn": "N0ZqISU3Qw-ZmDsZikbp4w", "file_name":"BIM Integration Prototype 1.0.pdf", "version_number":1, "parent_folder_urn": "urn:adsk.wipprod:fs.folder:co.3JagzATeQSmJI_o8djvF_Q"},
          {"workflow_transmittal_id":"856313e9-272c-4048-8987-e13a58ab3b9c", "urn": "5PfUdMeESQ6S8XmZ5lCPaw", "file_name":"麦当劳结构模型.rvt", "version_number":1, "parent_folder_urn": "urn:adsk.wipprod:fs.folder:co.3JagzATeQSmJI_o8djvF_Q"}
        ];

        // 3. transmittals_transmittal_recipients.csv
        const rawRecipients = [
          {"workflow_transmittal_id":"38afb8fd-c4d1-4d49-8750-84c1945479ba", "user_name":"Khalil Chiu", "email":"khalil.chiu@isbim.com.hk", "viewed_at":"2025-10-27 06:24:05.696", "downloaded_at":"2025-10-27 06:24:22.639"},
          {"workflow_transmittal_id":"38afb8fd-c4d1-4d49-8750-84c1945479ba", "user_name":"Dickson Lai", "email":"tllai.dickson@gmail.com", "viewed_at":null, "downloaded_at":null},
          {"workflow_transmittal_id":"856313e9-272c-4048-8987-e13a58ab3b9c", "user_name":"Dickson Lai", "email":"tllai.dickson@gmail.com", "viewed_at":null, "downloaded_at":null},
          {"workflow_transmittal_id":"856313e9-272c-4048-8987-e13a58ab3b9c", "user_name":"Eric Siu", "email":"eric@isbim.com.hk", "viewed_at":null, "downloaded_at":null},
          {"workflow_transmittal_id":"856313e9-272c-4048-8987-e13a58ab3b9c", "user_name":"Eric isBIM", "email":"eric@isbim.asia", "viewed_at":null, "downloaded_at":null}
        ];

        // 4. transmittals_transmittal_non_members.csv (Empty)
        const rawNonMembers = [];

        // --- Data Processing (Meaningful Translation) ---
        
        /**
         * Formats an ISO date string
         * @param {string} isoString - The date string
         * @returns {string} - Formatted date
         */
        function formatDateTime(isoString) {
            if (!isoString) return 'N/A';
            try {
                const date = new Date(isoString);
                return date.toLocaleString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            } catch (e) {
                return isoString;
            }
        }
        
        /**
         * Translates transmittal status code
         * @param {number} status - Status code
         * @returns {string} - Status text
         */
        function translateTransmittalStatus(status) {
            switch(status) {
                case 2: return "Sent";
                case 1: return "Draft";
                case 3: return "Closed";
                default: return "Unknown";
            }
        }
        
        /**
         * Gets recipient status
         * @param {object} recipient - Recipient object
         * @returns {object} - Object with text and Tailwind class
         */
        function getRecipientStatus(recipient) {
            if (recipient.downloaded_at) {
                return { text: "Downloaded", class: "bg-blue-100 text-blue-800" };
            }
            if (recipient.viewed_at) {
                return { text: "Viewed", class: "bg-green-100 text-green-800" };
            }
            return { text: "Not Viewed", class: "bg-gray-100 text-gray-800" };
        }

        // --- Core Processing Logic ---
        // Combine all data into a meaningful structure
        const processedTransmittals = rawTransmittals.map(transmittal => {
            // 1. Find documents for this transmittal
            // *** Updated: Include URN and parent_folder_urn ***
            const documents = rawDocuments
                .filter(doc => doc.workflow_transmittal_id === transmittal.id)
                .map(doc => ({
                    name: doc.file_name,
                    version: doc.version_number,
                    urn: doc.urn,
                    parent_folder_urn: doc.parent_folder_urn // <-- Added
                }));

            // 2. Find recipients (members) for this transmittal
            const recipients = rawRecipients
                .filter(rec => rec.workflow_transmittal_id === transmittal.id)
                .map(rec => ({
                    name: rec.user_name,
                    email: rec.email,
                    status: getRecipientStatus(rec)
                }));
            
            // 3. Find recipients (non-members) - empty in this example
            const nonMemberRecipients = rawNonMembers
                .filter(rec => rec.workflow_transmittal_id === transmittal.id)
                .map(rec => ({
                    name: `${rec.first_name || ''} ${rec.last_name || ''}`.trim() || rec.email,
                    email: rec.email,
                    status: getRecipientStatus(rec)
                }));

            // 4. Combine final object
            return {
                id: transmittal.id,
                title: transmittal.title,
                sender: transmittal.create_user_name,
                date: transmittal.created_at,
                formattedDate: formatDateTime(transmittal.created_at),
                status: translateTransmittalStatus(transmittal.status),
                documents: documents,
                allRecipients: [...recipients, ...nonMemberRecipients]
            };
        });

        // --- Render Logic ---
        
        const transmittalListEl = document.getElementById('transmittal-list');
        const detailViewEl = document.getElementById('detail-view');
        let selectedTransmittalId = null;

        /**
         * Renders the transmittal list
         */
        function renderTransmittalList() {
            if (processedTransmittals.length === 0) {
                transmittalListEl.innerHTML = '<div class="p-4 text-center text-gray-500">No transmittals found.</div>';
                return;
            }

            transmittalListEl.innerHTML = ''; // Clear list
            processedTransmittals.forEach(t => {
                const isActive = t.id === selectedTransmittalId;
                const activeClass = isActive ? 'bg-blue-50 border-r-4 border-blue-500' : 'hover:bg-gray-50';
                
                const itemEl = document.createElement('article');
                itemEl.className = `block cursor-pointer border-b border-gray-200 p-4 ${activeClass}`;
                itemEl.dataset.id = t.id;
                itemEl.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-semibold text-gray-900 truncate" title="${t.title}">${t.title}</h3>
                        <span class="text-xs text-gray-500 flex-shrink-0 ml-2">${t.formattedDate.split(',')[0]}</span>
                    </div>
                    <p class="text-sm text-gray-600">By ${t.sender}</p>
                    <div class="mt-2">
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${t.status === 'Sent' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${t.status}
                        </span>
                    </div>
                `;
                itemEl.addEventListener('click', () => handleTransmittalClick(t.id));
                transmittalListEl.appendChild(itemEl);
            });
        }

        /**
         * Handles clicking on a transmittal
         * @param {string} transmittalId - The ID of the clicked transmittal
         */
        function handleTransmittalClick(transmittalId) {
            selectedTransmittalId = transmittalId;
            const transmittal = processedTransmittals.find(t => t.id === transmittalId);
            if (transmittal) {
                renderDetailView(transmittal);
            }
            // Re-render list to update active state
            renderTransmittalList();
        }

        /**
         * Renders the detail view
         * @param {object} t - The transmittal object to display
         */
        function renderDetailView(t) {
            // 1. Render document list
            // *** Updated: Shows File URN and Folder URN ***
            const documentsHtml = t.documents.length > 0
                ? t.documents.map(doc => `
                    <li class="flex flex-col items-start justify-between py-3 pl-3 pr-4 text-sm">
                        <!-- File name and version -->
                        <div class="flex w-full items-center justify-between">
                            <div class="flex w-0 flex-1 items-center">
                                <!-- File icon -->
                                <svg class="h-5 w-5 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M15.621 4.379a3 3 0 00-4.242 0l-7 7a3 3 0 004.241 4.243h.001l.497-.5a.75.75 0 011.064 1.057l-.498.501-.002.002a4.5 4.5 0 01-6.364-6.364l7-7a4.5 4.5 0 016.368 6.36l-3.455 3.553A2.625 2.625 0 119.52 9.52l3.45-3.451a.75.75 0 111.061 1.06l-3.45 3.452a1.125 1.125 0 001.59 1.591l3.455-3.553a3 3 0 000-4.242z" clip-rule="evenodd" />
                                </svg>
                                <span class="ml-2 w-0 flex-1 truncate" title="${doc.name}">${doc.name}</span>
                            </div>
                            <div class="ml-4 flex-shrink-0">
                                <span class="text-gray-500">Version ${doc.version}</span>
                            </div>
                        </div>
                        <!-- URNs -->
                        <div class="mt-2 pl-7 w-full">
                            <p class="text-xs text-gray-500 truncate" title="File URN: ${doc.urn}">
                                <span class="font-medium text-gray-700">File URN:</span> 
                                <a href="#" onclick="event.preventDefault(); alert('File URN: ${doc.urn}')" class="text-blue-600 hover:text-blue-500">${doc.urn}</a>
                            </p>
                            <p class="text-xs text-gray-500 truncate" title="Folder URN: ${doc.parent_folder_urn}">
                                <span class="font-medium text-gray-700">Folder URN:</span> 
                                <a href="#" onclick="event.preventDefault(); alert('Folder URN: ${doc.parent_folder_urn}')" class="text-blue-600 hover:text-blue-500">${doc.parent_folder_urn}</a>
                            </p>
                        </div>
                    </li>
                `).join('')
                : '<li class="py-3 pl-3 pr-4 text-sm text-gray-500">No documents.</li>';

            // 2. Render recipient list
            const recipientsHtml = t.allRecipients.length > 0
                ? t.allRecipients.map(rec => `
                    <li class="flex items-center justify-between py-3 text-sm">
                        <div class="flex flex-col">
                            <span class="font-medium text-gray-900">${rec.name}</span>
                            <span class="text-gray-500">${rec.email}</span>
                        </div>
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${rec.status.class}">
                            ${rec.status.text}
                        </span>
                    </li>
                `).join('')
                : '<li class="py-3 text-sm text-gray-500">No recipients.</li>';

            // 3. Combine full HTML
            detailViewEl.innerHTML = `
                <header class="border-b border-gray-200 bg-white p-4">
                    <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:tracking-tight">${t.title}</h2>
                    <div class="mt-1 flex flex-col sm:flex-row sm:flex-wrap sm:space-x-6">
                        <div class="mt-2 flex items-center text-sm text-gray-500">
                            <!-- Sender icon -->
                            <svg class="mr-1.5 h-5 w-5 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-5.5-2.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM10 12a5.99 5.99 0 00-4.793 2.39A6.483 6.483 0 0010 16.5a6.483 6.483 0 004.793-2.11A5.99 5.99 0 0010 12z" clip-rule="evenodd" />
                            </svg>
                            Sender: ${t.sender}
                        </div>
                        <div class="mt-2 flex items-center text-sm text-gray-500">
                            <!-- Date icon -->
                            <svg class="mr-1.5 h-5 w-5 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.75 3a.75.75 0 01.75.75v.25h7.5V3.75a.75.75 0 011.5 0v.25h.75a2 2 0 012 2v11a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2h.75V3.75A.75.75 0 015.75 3zM2.5 7.5v10A.5.5 0 003 18h14a.5.5 0 00.5-.5V7.5h-15z" clip-rule="evenodd" />
                            </svg>
                            Date: ${t.formattedDate}
                        </div>
                        <div class="mt-2 flex items-center text-sm text-gray-500">
                            <!-- Status icon -->
                            <svg class="mr-1.5 h-5 w-5 flex-shrink-0 ${t.status === 'Sent' ? 'text-green-400' : 'text-gray-400'}" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                            </svg>
                            Status: ${t.status}
                        </div>
                    </div>
                </header>

                <div class="p-6 space-y-6">
                    <!-- Documents Section -->
                    <section>
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Included Documents (${t.documents.length})</h3>
                        <div class="mt-4 border-t border-b border-gray-200">
                            <ul role="list" class="divide-y divide-gray-200">
                                ${documentsHtml}
                            </ul>
                        </div>
                    </section>

                    <!-- Recipients Section -->
                    <section>
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Recipients (${t.allRecipients.length})</h3>
                        <div class="mt-4 border-t border-b border-gray-200">
                            <ul role="list" class="divide-y divide-gray-200">
                                ${recipientsHtml}
                            </ul>
                        </div>
                    </section>
                </div>
            `;
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            renderTransmittalList();
        });

    </script>
</body>
</html>
